# CLAUDE.md 記載方針

このドキュメントは、プロジェクトの `CLAUDE.md` ファイルを作成・更新する際の指針を定めています。

## 目的

CLAUDE.md は AI アシスタントがセッション開始時に読み込み、プロジェクト固有のルールやパターンを理解するためのドキュメントです。

**主な目標**:
- コンテキスト消費の最小化（セッション開始時の読み込み効率）
- AI が繰り返すミスを防ぐための詳細な情報提供
- 人間にとっても理解しやすい構造

## 基本原則

### 1. 簡潔さとコンテキスト効率

**DO**:
- 短く明確な文章
- 視覚的なフロー図（`↓` を使った矢印）
- 箇条書きとテーブル形式
- 必要最小限の説明

**DON'T**:
- 冗長な説明や重複
- 不要な装飾（`---` 等の水平線）
- 過度に深い階層構造（目次は2階層まで）
- 長いコード例（既存コード参照を推奨）

### 2. WHY を明記

ルールには必ず理由を添える：

```markdown
**WHY**: 憶測で実装すると、存在しない機能のテストを書いたり、手戻りが発生する
```

### 3. DO/DON'T 形式

明確な対比で理解しやすく：

```markdown
### DO
- エラーは必ず `errors.Wrap()` でラップ
- 明示的な返り値

### DON'T
- 生のエラーをそのまま返す
- 名前付き返り値
```

### 4. フロー図の活用

時系列のプロセスは矢印で表現：

```markdown
対象メソッド全体を読む
↓
内部メソッド・型定義を確認
↓
既存の類似実装を参考
↓
実装開始
```

### 5. 具体例の提供

抽象的な説明だけでなく、具体例を示す：

```markdown
**スコープ外変更の例**: `analyzer.Analyze()` の実装タスクで `encoder.Encode()` のロジックを変更するのは不適切
```

## ファイル構成

### ルート CLAUDE.md

#### 共通のルール

**推奨セクション**:
1. 基本方針
2. ツール使用ガイド（Serena MCP, MySQL MCP 等）
3. コーディングルール（言語固有の規約）
4. 実装フロー（事前確認、実装中、完了時）
5. テスト実装（パターン、リファクタリング時）
6. 問題発生時の対応
7. Git 操作

#### 実装固有のルール

**推奨セクション**:
1. 概要（技術スタック）
2. 開発プロセス
3. 開発コマンド
4. アーキテクチャ
5. 重要なパターン（DB操作、トランザクション等）
6. テスト戦略
7. よくある間違い（テーブル形式）
8. プロジェクト固有の注意事項

## セクション別ガイドライン

### ツール使用ガイド

優先順位を明確に：

```markdown
### Serena MCP（コード確認）
⚠️ コード確認では Serena MCP を最優先で使用

**優先順位**:
1. **Serena MCP** - シンボル検索・実装確認
2. Read - 設定ファイルのみ
3. Grep - 最終手段
```

### コーディングルール

DO/DON'T 形式で明確に：

```markdown
### DO
- エラーは必ず `errors.Wrap()` でラップ
  - `errors.Wrap()`: 既存エラーにコンテキスト追加
  - `errors.Is()`: エラー判定

### DON'T
- 生のエラーをそのまま返す
```

### 実装フロー

段階ごとに分けて記載：

```markdown
### 1. 事前確認（必須）
⚠️ **憶測禁止**: 必ず実装を確認してから作業

対象メソッド全体を読む
↓
内部メソッド・型定義を確認
↓
実装開始

**WHY**: 憶測で実装すると手戻りが発生する
```

## 更新とメンテナンス

### リライト時の手順

1. **既存ドキュメント分析**
  - 冗長な部分を特定
  - 重複を排除
  - 不要なセクションを削除

2. **重要情報の確認**
  - AI が繰り返すミスに関する情報は必ず保持
  - 具体的なコマンドや設定値
  - プロジェクト固有のパターン

3. **構造の最適化**
  - 浅い階層構造
  - フロー図の活用
  - DO/DON'T 形式への変換

4. **比較レビュー**
  - 元のドキュメントと REWRITE 版を比較
  - 欠落した重要情報を統合
  - コンテキスト消費量を確認

### バージョン管理

- コミットメッセージに改善点を明記
- 大幅な変更は段階的に実施

## チェックリスト

リライト完了前に確認：

- [ ] コンテキスト消費が削減されているか
- [ ] 重要な詳細情報は維持されているか
- [ ] WHY が明記されているか
- [ ] 具体例が含まれているか
- [ ] フロー図が適切に使われているか
- [ ] DO/DON'T が明確か
- [ ] 階層構造は浅いか（2階層まで）
- [ ] コード例は最小限か
- [ ] 元のドキュメントから欠落した情報はないか

## 推奨される行数

- **ルート CLAUDE.md**: 150-200行

これらは目安であり、必要に応じて調整可能です。重要なのは**簡潔さと必要な詳細のバランス**です。

## 参考例

現在の CLAUDE.md ファイルが参考例となります：

- `/CLAUDE.md` (167行)
